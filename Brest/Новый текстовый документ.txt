# Развертывание ПК СВ Брест при помощи скриптов
Скрипты сделаны на основе инструкций по установке ПК СВ Брест. В данном документе описан алгоритм работы с разработанными скриптами. 
Детальные подробности о развертывании ПК СВ Брест можно найти тут: https://wiki.astralinux.ru/pages/viewpage.action?pageId=102007178

Представлены 2 скрипта для автоматической настройки фронтальной машины **front.sh** и автоматической настройки RAFT **RAFT.sh**

Ограничения
В скриптах отсутствует генерация SSL сертификатов и keytab файлов. Сертификаты указаны в конфигурационном файле Apache, но отсутствуют в системе, поэтому apache не запустится!

Данный функционал находится в разработке Астры. Генерировать ключи можно через openssl.

Keytab файлы создаются по этой инструкции.

Далее:

После получения билетов вызываем утилиту:

ktutil

и объединяем с ее помощью билеты:

rkt /etc/apache2/apache2.<floating-name>.keytab
rkt /etc/apache2/apache2.<front-N-hostname>.keytab
wkt /etc/apache2/apache2.keytab
q

меняем владельца и права на полученный файл:

chown www-data:www-data /etc/apache2/apache2.keytab
chmod 440 /etc/apache2/apache2.keytab

После всех настроек перезапустить сервис:

systemctl restart apache2

## Итоговая конфигурация

Результатом исполнения скриптов являются сконфигурированные фронтальные сервера и узлы виртуализации. При разработке использовалась следующая модель:- три сервера фронт + узел виртуализации (далее - фронтальный сервер)- сервер или виртуальная машина, на которой расположен контроллер домена FreeIPA.

## Требования
Перед запуском скриптов, убедитесь, что выполнены требования:

- развернут контроллер домена FreeIPA
- на серверах развернута ОС согласно инструкции
Обратите внимание, что в данной конфигурации серверов сеть настраивается в режиме моста.

После установки ОС на очередной сервер, необходимо создать папку /iso. В ней необходимо расположить ISO образы, необходимые для обновления ОС и установки ПК СВ Брест.
Образы должны быть названы следующими именами:

OS.iso – установочный диск
OS-upd.iso – диск, содержащий обновления установочного диска и диска разработчика
OS-dev.iso – диск разработчикаbrest.iso – установочный диск ПК СВ Брест
brest.iso – установочный диск ПК СВ Брест
Запуск скриптов
Первым запускается скрипт front.sh, затем, после успешной настройки, запускается скрипт RAFT.sh. Скрипты запускается при помощи команды sudo <имя скрипта>.sh

## Функциональное описание
### front.sh

Скрипт запускается при помощи команды sudo bash front.sh

Функции скрипта:

- создает и монтирует репозиторий

- обновляет ОС, устанавливает необходимые пакеты

- вводит сервер в домен FreeIPA

- повышает уровень целостности администратора

- обменивается ssh ключами

- настраивает службы ПК СВ Брест

- обменивается ssh ключами с двумя другими фронтальными серверами

- создает конфигурационный файл apache ( 000-default.conf )


Скрипт выполняется на всех (трех) фронтальных машинах (фронтальные машины совмещены с узлами виртуализации). Все машины должны быть включены – это необходимо для обмена ssh ключами.

Скрипт запускается несколько раз – после каждой перезагрузки необходимо заново запустить скрипт. Основные данные, используемые в ходе работы скрипта сохраняются в файл /opt/script_data. В ходе работы отслеживаются этапы выполнения скрипта, этапы сохраняются в файле /opt/script_state, после каждой перезагрузки работа продолжается следующим этапом. При окончании работы скрипта, последние файлы удаляются.

В ходе выполнения правятся следующие файлы:

/etc/apt/sources.list

/etc/hostname

/etc/hosts

/etc/resolv.conf

/etc/default/grub

Также, для каждого сервера регенерируется ssh ключ.

### RAFT.sh

Скрипт запускается из-под администратора root. И только на одном сервере.

Скрипт включает два этапа исполнения:

 настройка RAFT на главенствующем фронтальном сервере
 добавление ведомых узлов в зону, загрузка базы данных на ведомые узлы, настройка oned.conf ведомых узлов

Функции скрипта:

1 Этап:

- создание зоны
- включение RAFT
- конфигурация файла oned.conf
- создание базы данных

2 Этап:

- добавление ведомых серверов в зону
- копирование базы данных на ведомые сервера с центрального
- конфигурация файла oned.conf


В скрипт включена проверка повторного добавления ведомого сервера в зону. При повторном добавлении сервера, скрипт выдаст ошибку - "сервер уже введен в зону" и остановит работу. Это сделано для недопущения назначения одному серверу разных ID зоны.

Два этапа работы скрипта сделаны для разрешения возможных проблем при настройке RAFT.

В ходе выполнения правятся следующие файлы:

/etc/one/oned.conf
